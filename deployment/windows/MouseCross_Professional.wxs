<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package Name="MouseCross"
           Manufacturer="Stefan Lohmaier"
           Version="0.1.12"
           UpgradeCode="B8F5E4C2-7A9D-4E87-9F3B-2C8A1D5E6B7A"
           InstallerVersion="500"
           Compressed="yes"
           Language="1033"
           Scope="perMachine">

    <!-- Product Information -->
    <SummaryInformation
      Keywords="MouseCross,Visual,Mouse,Locator,Accessibility"
      Description="MouseCross - Visual Mouse Locator for Accessibility"
      Manufacturer="Stefan Lohmaier"/>

    <!-- Upgrade Logic - Replace older versions automatically -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of MouseCross is already installed. Setup will now exit."
      Schedule="afterInstallInitialize"
      AllowSameVersionUpgrades="yes"/>

    <!-- Media -->
    <Media Id="1" Cabinet="MouseCross.cab" EmbedCab="yes" />

    <!-- Icons and Banners -->
    <Icon Id="MouseCrossIcon" SourceFile="$(var.SourceDir)\MouseCross.exe" />
    <Property Id="ARPPRODUCTICON" Value="MouseCrossIcon" />
    <Property Id="ARPHELPLINK" Value="https://slohmaier.de/mousecross" />
    <Property Id="ARPURLINFOABOUT" Value="https://slohmaier.de/mousecross" />
    <Property Id="ARPNOREPAIR" Value="yes" />
    <Property Id="ARPNOMODIFY" Value="yes" />

    <!-- Default Property Values -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="CREATE_DESKTOP_SHORTCUT" Value="1" Secure="yes" />
    <Property Id="CREATE_STARTMENU_SHORTCUT" Value="1" Secure="yes" />
    <Property Id="AUTOSTART_ENABLED" Value="0" Secure="yes" />
    <Property Id="LAUNCH_APPLICATION" Value="1" Secure="yes" />

    <!-- Check if MouseCross is running -->
    <Property Id="MOUSECROSS_RUNNING">
      <DirectorySearch Id="SystemFolderSearch" Path="[SystemFolder]">
        <FileSearch Name="tasklist.exe" />
      </DirectorySearch>
    </Property>

    <!-- Directory Structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="MouseCross">
        <Directory Id="PLATFORMSDIR" Name="platforms" />
        <Directory Id="STYLESDIR" Name="styles" />
        <Directory Id="IMAGEFORMATSDIR" Name="imageformats" />
        <Directory Id="ICONENGINESDIR" Name="iconengines" />
        <Directory Id="GENERICDIR" Name="generic" />
        <Directory Id="TLSDIR" Name="tls" />
        <Directory Id="NETWORKINFORMATIONDIR" Name="networkinformation" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder" />

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="MouseCross" />
    </StandardDirectory>

    <!-- Components -->
    <!-- Main Executable -->
    <Component Id="MainExecutable" Directory="INSTALLFOLDER" Guid="A1B2C3D4-5678-90AB-CDEF-111111111111">
      <File Id="MouseCrossExe" Source="$(var.SourceDir)\MouseCross.exe" KeyPath="yes" />

      <!-- Registry entries for proper uninstall -->
      <RegistryValue Root="HKLM"
                    Key="SOFTWARE\Stefan Lohmaier\MouseCross"
                    Name="InstallPath"
                    Value="[INSTALLFOLDER]"
                    Type="string" />
      <RegistryValue Root="HKLM"
                    Key="SOFTWARE\Stefan Lohmaier\MouseCross"
                    Name="Version"
                    Value="0.1.12"
                    Type="string" />
    </Component>

    <!-- Desktop Shortcut -->
    <Component Id="DesktopShortcut" Directory="DesktopFolder" Guid="A1B2C3D4-5678-90AB-CDEF-222222222222">
      <Condition>CREATE_DESKTOP_SHORTCUT="1"</Condition>
      <Shortcut Id="DesktopShortcut"
               Name="MouseCross"
               Description="Visual Mouse Locator for Accessibility"
               Target="[INSTALLFOLDER]MouseCross.exe"
               WorkingDirectory="INSTALLFOLDER"
               Icon="MouseCrossIcon" />
      <RemoveFolder Id="CleanupDesktopShortcut" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\Stefan Lohmaier\MouseCross"
                    Name="desktop_shortcut" Type="integer" Value="1" KeyPath="yes"/>
    </Component>

    <!-- Start Menu Shortcut -->
    <Component Id="StartMenuShortcut" Directory="ApplicationProgramsFolder" Guid="A1B2C3D4-5678-90AB-CDEF-333333333333">
      <Condition>CREATE_STARTMENU_SHORTCUT="1"</Condition>
      <Shortcut Id="ApplicationStartMenuShortcut"
               Name="MouseCross"
               Description="Visual Mouse Locator for Accessibility"
               Target="[INSTALLFOLDER]MouseCross.exe"
               WorkingDirectory="INSTALLFOLDER"
               Icon="MouseCrossIcon" />
      <Shortcut Id="UninstallStartMenuShortcut"
               Name="Uninstall MouseCross"
               Description="Uninstalls MouseCross"
               Target="[System64Folder]msiexec.exe"
               Arguments="/x [ProductCode]"
               Icon="MouseCrossIcon" />
      <RemoveFolder Id="CleanupStartMenuFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\Stefan Lohmaier\MouseCross"
                    Name="startmenu_shortcut" Type="integer" Value="1" KeyPath="yes"/>
    </Component>

    <!-- Auto-start Registry -->
    <Component Id="AutoStart" Directory="INSTALLFOLDER" Guid="A1B2C3D4-5678-90AB-CDEF-444444444444">
      <Condition>AUTOSTART_ENABLED="1"</Condition>
      <RegistryValue Root="HKLM"
                    Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
                    Name="MouseCross"
                    Value="&quot;[INSTALLFOLDER]MouseCross.exe&quot;"
                    Type="string" KeyPath="yes"/>
    </Component>

    <!-- Qt Core Libraries -->
    <Component Id="QtCore" Directory="INSTALLFOLDER" Guid="*">
      <File Id="Qt6CoreDll" Source="$(var.SourceDir)\Qt6Core.dll" KeyPath="yes" />
    </Component>

    <Component Id="QtGui" Directory="INSTALLFOLDER" Guid="*">
      <File Id="Qt6GuiDll" Source="$(var.SourceDir)\Qt6Gui.dll" KeyPath="yes" />
    </Component>

    <Component Id="QtWidgets" Directory="INSTALLFOLDER" Guid="*">
      <File Id="Qt6WidgetsDll" Source="$(var.SourceDir)\Qt6Widgets.dll" KeyPath="yes" />
    </Component>

    <Component Id="QtNetwork" Directory="INSTALLFOLDER" Guid="*">
      <File Id="Qt6NetworkDll" Source="$(var.SourceDir)\Qt6Network.dll" KeyPath="yes" />
    </Component>

    <Component Id="QtSvg" Directory="INSTALLFOLDER" Guid="*">
      <File Id="Qt6SvgDll" Source="$(var.SourceDir)\Qt6Svg.dll" KeyPath="yes" />
    </Component>

    <!-- DirectX Components (only for x64) -->
    <Component Id="DxCompiler" Directory="INSTALLFOLDER" Guid="*">
      <Condition>%PROCESSOR_ARCHITECTURE="AMD64"</Condition>
      <File Id="DxCompilerDll" Source="$(var.SourceDir)\dxcompiler.dll" KeyPath="yes" />
    </Component>

    <Component Id="DxIL" Directory="INSTALLFOLDER" Guid="*">
      <Condition>%PROCESSOR_ARCHITECTURE="AMD64"</Condition>
      <File Id="DxILDll" Source="$(var.SourceDir)\dxil.dll" KeyPath="yes" />
    </Component>

    <!-- Visual C++ Redistributable (only for x64) -->
    <Component Id="VCRedist" Directory="INSTALLFOLDER" Guid="*">
      <Condition>%PROCESSOR_ARCHITECTURE="AMD64"</Condition>
      <File Id="VCRedistExe" Source="$(var.SourceDir)\vc_redist.x64.exe" KeyPath="yes" />
    </Component>

    <!-- Qt Plugins -->
    <Component Id="PlatformsPlugin" Directory="PLATFORMSDIR" Guid="*">
      <File Id="QWindowsDll" Source="$(var.SourceDir)\platforms\qwindows.dll" KeyPath="yes" />
    </Component>

    <Component Id="StylesPlugin" Directory="STYLESDIR" Guid="*">
      <File Id="QModernWindowsStyleDll" Source="$(var.SourceDir)\styles\qmodernwindowsstyle.dll" KeyPath="yes" />
    </Component>

    <!-- Image Format Plugins -->
    <Component Id="ImageFormatGif" Directory="IMAGEFORMATSDIR" Guid="*">
      <File Id="QGifDll" Source="$(var.SourceDir)\imageformats\qgif.dll" KeyPath="yes" />
    </Component>

    <Component Id="ImageFormatIco" Directory="IMAGEFORMATSDIR" Guid="*">
      <File Id="QIcoDll" Source="$(var.SourceDir)\imageformats\qico.dll" KeyPath="yes" />
    </Component>

    <Component Id="ImageFormatJpeg" Directory="IMAGEFORMATSDIR" Guid="*">
      <File Id="QJpegDll" Source="$(var.SourceDir)\imageformats\qjpeg.dll" KeyPath="yes" />
    </Component>

    <Component Id="ImageFormatSvg" Directory="IMAGEFORMATSDIR" Guid="*">
      <File Id="QSvgImageDll" Source="$(var.SourceDir)\imageformats\qsvg.dll" KeyPath="yes" />
    </Component>

    <Component Id="IconEnginesPlugin" Directory="ICONENGINESDIR" Guid="*">
      <File Id="QSvgIconDll" Source="$(var.SourceDir)\iconengines\qsvgicon.dll" KeyPath="yes" />
    </Component>

    <Component Id="GenericPlugin" Directory="GENERICDIR" Guid="*">
      <File Id="QTuioTouchPluginDll" Source="$(var.SourceDir)\generic\qtuiotouchplugin.dll" KeyPath="yes" />
    </Component>

    <!-- TLS Plugins -->
    <Component Id="TlsCertOnly" Directory="TLSDIR" Guid="*">
      <File Id="QCertOnlyBackendDll" Source="$(var.SourceDir)\tls\qcertonlybackend.dll" KeyPath="yes" />
    </Component>

    <Component Id="TlsSchannel" Directory="TLSDIR" Guid="*">
      <File Id="QSchannelBackendDll" Source="$(var.SourceDir)\tls\qschannelbackend.dll" KeyPath="yes" />
    </Component>

    <Component Id="NetworkInfoPlugin" Directory="NETWORKINFORMATIONDIR" Guid="*">
      <File Id="QNetworkListManagerDll" Source="$(var.SourceDir)\networkinformation\qnetworklistmanager.dll" KeyPath="yes" />
    </Component>

    <!-- Features -->
    <Feature Id="Complete" Title="MouseCross Application" Level="1"
             Description="The complete MouseCross application with all required components."
             Display="expand" ConfigurableDirectory="INSTALLFOLDER"
             AllowAdvertise="no" InstallDefault="local" Absent="disallow">

      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="QtCore" />
      <ComponentRef Id="QtGui" />
      <ComponentRef Id="QtWidgets" />
      <ComponentRef Id="QtNetwork" />
      <ComponentRef Id="QtSvg" />
      <ComponentRef Id="DxCompiler" />
      <ComponentRef Id="DxIL" />
      <ComponentRef Id="VCRedist" />
      <ComponentRef Id="PlatformsPlugin" />
      <ComponentRef Id="StylesPlugin" />
      <ComponentRef Id="ImageFormatGif" />
      <ComponentRef Id="ImageFormatIco" />
      <ComponentRef Id="ImageFormatJpeg" />
      <ComponentRef Id="ImageFormatSvg" />
      <ComponentRef Id="IconEnginesPlugin" />
      <ComponentRef Id="GenericPlugin" />
      <ComponentRef Id="TlsCertOnly" />
      <ComponentRef Id="TlsSchannel" />
      <ComponentRef Id="NetworkInfoPlugin" />

      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="StartMenuShortcut" />
      <ComponentRef Id="AutoStart" />
    </Feature>

    <!-- Custom Actions -->
    <!-- Check if MouseCross is running -->
    <CustomAction Id="CheckMouseCrossRunning"
                  Property="MOUSECROSS_IS_RUNNING"
                  ExeCommand="cmd.exe /c &quot;tasklist /FI \&quot;IMAGENAME eq MouseCross.exe\&quot; 2&gt;NUL | find /I /N \&quot;MouseCross.exe\&quot;&gt;NUL &amp;&amp; echo 1 || echo 0&quot;"
                  Execute="immediate"
                  Return="ignore" />

    <!-- Prompt user to close MouseCross -->
    <CustomAction Id="PromptCloseMouseCross"
                  DllEntry="WixCloseApplications"
                  Execute="immediate"
                  Return="check" />

    <!-- Kill MouseCross process -->
    <CustomAction Id="KillMouseCross"
                  ExeCommand="cmd.exe /c &quot;taskkill /F /IM MouseCross.exe 2&gt;NUL&quot;"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="no" />

    <!-- Launch MouseCross after installation -->
    <CustomAction Id="LaunchApplication"
                  FileKey="MouseCrossExe"
                  ExeCommand=""
                  Execute="immediate"
                  Return="asyncNoWait"
                  Impersonate="yes" />

    <!-- Set properties from registry (for upgrades) -->
    <Property Id="PREVIOUS_DESKTOP_SHORTCUT" Secure="yes">
      <RegistrySearch Id="PrevDesktopShortcut" Root="HKCU"
                     Key="Software\Stefan Lohmaier\MouseCross"
                     Name="desktop_shortcut" Type="raw" />
    </Property>

    <Property Id="PREVIOUS_STARTMENU_SHORTCUT" Secure="yes">
      <RegistrySearch Id="PrevStartMenuShortcut" Root="HKCU"
                     Key="Software\Stefan Lohmaier\MouseCross"
                     Name="startmenu_shortcut" Type="raw" />
    </Property>

    <!-- Set properties based on previous installation -->
    <SetProperty Id="CREATE_DESKTOP_SHORTCUT" Value="[PREVIOUS_DESKTOP_SHORTCUT]" After="AppSearch" Condition="PREVIOUS_DESKTOP_SHORTCUT" />
    <SetProperty Id="CREATE_STARTMENU_SHORTCUT" Value="[PREVIOUS_STARTMENU_SHORTCUT]" After="AppSearch" Condition="PREVIOUS_STARTMENU_SHORTCUT" />

    <!-- Install Sequences -->
    <InstallExecuteSequence>
      <Custom Action="KillMouseCross" After="InstallInitialize" Condition="NOT REMOVE" />
    </InstallExecuteSequence>

    <!-- UI Configuration -->
    <UI Id="MouseCrossUI">
      <TextStyle Id="WixUI_Font_Normal" FaceName="Segoe UI" Size="9" />
      <TextStyle Id="WixUI_Font_Bigger" FaceName="Segoe UI" Size="12" />
      <TextStyle Id="WixUI_Font_Title" FaceName="Segoe UI" Size="14" Bold="yes" />

      <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
      <Property Id="WixUI_Mode" Value="InstallDir" />

      <!-- Reference the built-in UI but customize the flow -->
      <ui:WixUI Id="WixUI_MouseCross" InstallDirectory="INSTALLFOLDER" />

      <!-- Custom dialog for options -->
      <Dialog Id="MouseCrossOptionsDlg" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Installation Options" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="Choose additional options for MouseCross installation" />
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.InstallDirDlgBannerBitmap)" />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />

        <!-- Options -->
        <Control Id="DesktopShortcutCheckBox" Type="CheckBox" X="20" Y="60" Width="330" Height="17"
                Property="CREATE_DESKTOP_SHORTCUT" CheckBoxValue="1"
                Text="Create a &amp;desktop shortcut" />

        <Control Id="StartMenuShortcutCheckBox" Type="CheckBox" X="20" Y="85" Width="330" Height="17"
                Property="CREATE_STARTMENU_SHORTCUT" CheckBoxValue="1"
                Text="Create a &amp;Start Menu shortcut" />

        <Control Id="AutoStartCheckBox" Type="CheckBox" X="20" Y="110" Width="330" Height="17"
                Property="AUTOSTART_ENABLED" CheckBoxValue="1"
                Text="&amp;Automatically start MouseCross when Windows starts" />

        <Control Id="OptionsText" Type="Text" X="20" Y="140" Width="330" Height="30"
                Text="MouseCross runs in the system tray and provides a crosshair overlay to help locate your mouse cursor." />

        <!-- Navigation buttons -->
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)" />
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="!(loc.WixUINext)" />
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>

      <!-- Customize Exit Dialog -->
      <Dialog Id="MouseCrossExitDialog" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="Finish" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Cancel="yes" Text="!(loc.WixUIFinish)" />
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Disabled="yes" Text="!(loc.WixUICancel)" />
        <Control Id="Bitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="234" TabSkip="no" Text="!(loc.DialogBitmap)" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Disabled="yes" Text="!(loc.WixUIBack)" />
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Title" Type="Text" X="135" Y="20" Width="220" Height="60" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Installation Complete" />
        <Control Id="Description" Type="Text" X="135" Y="90" Width="220" Height="40" Transparent="yes" NoPrefix="yes" Text="MouseCross has been successfully installed on your computer." />

        <!-- Launch checkbox -->
        <Control Id="LaunchCheckBox" Type="CheckBox" X="135" Y="160" Width="220" Height="17"
                Property="LAUNCH_APPLICATION" CheckBoxValue="1"
                Text="&amp;Launch MouseCross now" />

        <Control Id="InfoText" Type="Text" X="135" Y="185" Width="220" Height="40" Transparent="yes" NoPrefix="yes"
                Text="MouseCross will run in your system tray. Right-click the tray icon to access settings." />
      </Dialog>

      <!-- Dialog sequence customization -->
      <InstallUISequence>
        <Show Dialog="MouseCrossExitDialog" OnExit="success" Condition="NOT Installed" />
      </InstallUISequence>

      <!-- Publish events for custom dialogs -->
      <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="MouseCrossOptionsDlg">1</Publish>
      <Publish Dialog="MouseCrossOptionsDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
      <Publish Dialog="MouseCrossOptionsDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="MouseCrossOptionsDlg">1</Publish>

      <!-- Handle launch on exit -->
      <Publish Dialog="MouseCrossExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">
        LAUNCH_APPLICATION = "1" AND NOT Installed
      </Publish>
      <Publish Dialog="MouseCrossExitDialog" Control="Finish" Event="EndDialog" Value="Return">1</Publish>
    </UI>

    <!-- License file -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\license.rtf" />

    <!-- Banner and dialog bitmaps (optional - uses defaults if not provided) -->
    <!-- <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" /> -->
    <!-- <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" /> -->

  </Package>
</Wix>